import numpy as np
import pandas as pd
import pathlib
import matplotlib.pyplot as plt

class QuestionnaireAnalysis:
    """
    Reads and analyzes data generated by the questionnaire experiment.
    Should be able to accept strings and pathlib.Path objects.
    """

    def __init__(self, data_fname):
        self.data_fname = pathlib.Path(str(data_fname))
        if self.data_fname.exists()==False:
            raise ValueError("file is not exist")

    def read_data(self):
        """Reads the json data located in self.data_fname into memory, to
        the attribute self.data.
        """
        with open(self.data_fname, "r") as f:
            data = eval(f.read())
        self.data=pd.DataFrame(data).replace('nan', np.NaN)
        return self.data

    def show_age_distrib(self) -> [np.ndarray, np.ndarray]:
        """Calculates and plots the age distribution of the participants.

        Returns
        -------
        hist : np.ndarray
        Number of people in a given bin
        bins : np.ndarray
        Bin edges
        
        """   
        bins=np.arange(0.,110.,10.)
        hist_se=self.data['age'].dropna().groupby(pd.cut(self.data.age.dropna(), bins,right=False)).count()
        hist=hist_se.to_numpy().astype(float)
        plt.hist(self.data['age'].dropna(),bins=bins)
        plt.show()
        return hist, bins

    def remove_rows_without_mail(self) -> pd.DataFrame:
        """Checks self.data for rows with invalid emails, and removes them.

        Returns
        -------
        df : pd.DataFrame
        A corrected DataFrame, i.e. the same table but with the erroneous rows removed and
        the (ordinal) index after a reset.
            """
        df_with_at=self.data[self.data.email.str.contains("@")].reset_index(drop=True)
        df_without_at_c=df_with_at[~df_with_at.email.str.contains("@c")].reset_index(drop=True)
        df_without_at_dot_c=df_without_at_c[~df_without_at_c.email.str.contains("@.c")].reset_index(drop=True)
        return df_without_at_dot_c
    
    def fill_na_with_mean(self) -> [pd.DataFrame, np.ndarray]:
        """Finds, in the original DataFrame, the subjects that didn't answer
        all questions, and replaces that missing value with the mean of the
        other grades for that student.

        Returns
        -------
        df : pd.DataFrame
        The corrected DataFrame after insertion of the mean grade
        arr : np.ndarray
        Row indices of the students that their new grades were generated"""
        
        student=self.data[['q1','q2','q3','q4','q5']].isnull().any(axis=1).to_numpy()
        student_ind=np.argwhere(student==1).flatten()
        mean_value=self.data[['q1','q2','q3','q4','q5']].mean(axis=1,skipna=True)
        self.data[['q1','q2','q3','q4','q5']]=self.data[['q1','q2','q3','q4','q5']].T.fillna(mean_value).T
        return self.data, student_ind
        
